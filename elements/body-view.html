<link rel="import" href="../bower_components/polymer/polymer.html">


<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../bower_components/observe-js/observe-js.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="genre-list.html">
<link rel="import" href="anime-view.html">

<!--TEMPORARY-->
<link rel="import" href="anime-item.html">

<dom-module id="body-view">
    <style>
        #navBar {
            top: 0px;
            left: 0px;
            height: 50px;
            width: 100%
        }
        
        #navBar #busySpinner {
            position: absolute;
            margin: 10px;
            right: 0px;
        }
        
        #navBar::shadow .paper-toolbar {
            height: 50px;
            margin: 0px;
            padding: 0px;
        }

        #drawerPanel {
            top:0px;
            height: 100%;
        }
        
        #default .submenu {
            position: relative;
            width: calc(100% - 20px);
            left: 20px;
            margin: 0px; 
            padding: 0px;
            color:aqua;
        }
        
        .hidden {
            display: none;
        }
        
        #animeItemTest {
            
        }
    </style>
    
    <template>
        <paper-drawer-panel id="drawerPanel" selected="{{drawerPanelView}}" peeking="true">
            
            <!-- THE DRAWER -->
            <paper-material drawer elevation="2">
                <paper-header-panel>
                    <!--Sidebar Toolbar-->
                    <paper-toolbar id="navBar">
                        <paper-button disabled>IA1405</paper-button>
                        <paper-icon-button icon="arrow-back" id="backBtn"></paper-icon-button>
                        <paper-icon-button icon="search" id="searchBtn"></paper-icon-button>
                    </paper-toolbar>
                    
                    <!--Sidebar View Selector-->
                    <iron-pages id="sidebarPages" selected="{{sidebarSelected}}" attr-for-selected="id" 
                                style="overflow-y:auto;overflow-x:hidden;">
                        <!-- Options View -->
                        <div id="options">
                            <paper-item>Filter Options</paper-item>
                            <paper-button raised id="genreButton">Genre</paper-button>
                            <paper-button raised id="seasonsButton">Season</paper-button>
                        </div>
                        <!-- Genre list selector -->
                        <genre-list id="genres" selected-genres="{{selectedGenres}}" filter-adult="[[filterAdult]]"></genre-list>
                        <!-- Season selector -->
                        <div id="seasons">Seasons Selector Placeholder</div>
                    </iron-pages>
                </paper-header-panel>
            </paper-material>
            
            <!-- MAIN VIEW -->
            <iron-pages main id="mainSelector" attr-for-selected="id" selected="animeView">
                <anime-view id="animeView" animes="[[_animes]]"></anime-view>
            </iron-pages>
        </paper-drawer-panel>
        
    </template>
</dom-module>

<script>
    Polymer({
        is: 'body-view',
        properties: {
            sidebarSelected: {
                type: String,
                notify: true,
                observer: "_drawerViewObserver"
            },
            selectedGenres: {
                type: Array,
                notify: true,
                observer: "_genresObserver"
            },
            drawerPanelView: {
                type: String,
                observer: "_drawerStateObserver"
            },
            filterAdult: {
                type: Boolean,
                value: true,
                notify: true
            },
            _animes: {
                type: Array,
                value: [],
                notify: true
            }
        },
        
        ready: function() {
            this.sidebarSelected = "options";
            this._registerButtonHandlers();
            this._updateAnimeView({status:"Currently Airing",full_page:true,year:2015});
        },
        
        
        //Observers
        _drawerViewObserver: function(newV, oldV) {
            if (newV === "options") {
                this.toggleClass("hidden",true,this.$.backBtn);
            } else {;
                this.toggleClass("hidden",false,this.$.backBtn)
            }
        },
        _drawerStateObserver: function(newV,oldV) {
            switch(newV) {
                case "drawer":
                    
                    break;
                case "main":
                    if (this.$.drawerPanel.narrow) {
                        this.sidebarSelected = "options";
                    }
                    break;
            }
            
        },
        _genresObserver: function(newV,oldV) {
            if (typeof oldV !== 'undefined') {
                oldV.observer.close();
            }
            var onSelectionChanged = function(changes) {
            }.bind(this);
            newV.observer = new ArrayObserver(newV);
            newV.observer.open(onSelectionChanged);
        },
        
        //Event Handling
        _registerButtonHandlers: function() {
            this.$.backBtn.onclick = function() {
                this._onSidebarButtonClick("options")
            }.bind(this);
            this.$.genreButton.onclick = function() {
                this._onSidebarButtonClick("genres");
            }.bind(this);
            this.$.seasonsButton.onclick = function() {
                this._onSidebarButtonClick("seasons");
            }.bind(this);
        },
        
        _onSidebarButtonClick: function(button) {
            setTimeout(function() {
                this.sidebarSelected = button;
            }.bind(this),0);
        },
        
        //Main View data
        _filter: function(data) {
            if(!this.filterAdult) {
                return true;
            }
            return !data.adult;
        },
        
        _updateAnimeView: function(options) {
            alAPI.anime.browse(options,function(status, data) {
                if (status) {
                    this._getFullAnimeData(data);
                }
            }.bind(this));
        },
        _getFullAnimeData: function(data) {
            var animeID;
            while (data.length > 0) {
                animeID = data.shift().id;
                alAPI.anime.get("", animeID, function(status, data) {
                    if (status) {
                        if(this._filter(data)) {
                            this.push("_animes",data);
                        }
                    }
                }.bind(this));
            }
        },
    });
</script>