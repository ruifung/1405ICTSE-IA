<!--
This file is part of the custom-scroller for Polymer package.

(c) FranÃ§ois Pluchino <francois.pluchino@sonatra.com>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
-->

<!--
`custom-scroller` replace the default scrollbar by a custom scrollbar for the desktop browser.

##### Example

    <custom-scroller>
      <core-header-panel mode="scroll" scrollwrapper>
        <p>Content.</p>
      </core-header-panel>
    </custom-scroller drawer>

@element custom-scroller
@homepage http://sonatra.github.io/custom-scroller
-->
<link rel="import" href="../polymer/polymer.html">

<polymer-element name="custom-scroller" attributes="containerSelector scrollbarMinSize">
  <template>
    <link rel="stylesheet" href="custom-scroller.css">
    <content></content>
  </template>

  <script>
    (function () {
      'use strict';

      /**
       * Check is browser is Firefox.
       *
       * @return Boolean
       */
      function isFirefox() {
        return -1 !== navigator.userAgent.toLowerCase().indexOf('firefox');
      }

      /**
       * Get the width of native scrollbar.
       *
       * @returns {Number}
       */
      function getNativeScrollWidth() {
        var sbDiv = document.createElement("div"),
          size;
        sbDiv.style.width = '100px';
        sbDiv.style.height = '100px';
        sbDiv.style.overflow = 'scroll';
        sbDiv.style.position = 'absolute';
        sbDiv.style.top = '-9999px';

        document.body.appendChild(sbDiv);
        size = sbDiv.offsetWidth - sbDiv.clientWidth;
        document.body.removeChild(sbDiv);

        return size;
      }

      /**
       * Create the scrollbar.
       *
       * @param {Element} self The custom-scroller instance
       *
       * @return {Element} The scrollbar
       *
       * @private
       */
      function generateScrollbar(self) {
        var scrollbar = document.createElement("div");
        scrollbar.className = 'custom-scroller-scrollbar scrollbar-active';
        self.appendChild(scrollbar);

        return scrollbar;
      }

      /**
       * Add class name in element.
       *
       * @param {Element} element   The element
       * @param {String}  classname The class name
       *
       * @private
       */
      function addClass(element, classname) {
        if (-1 === element.className.indexOf(classname)) {
          element.className += ' scrollbar-active';
        }
      }

      /**
       * Remove class name in element.
       *
       * @param {Element} element   The element
       * @param {String}  classname The class name
       *
       * @private
       */
      function removeClass(element, classname) {
        if (-1 !== element.className.indexOf(classname)) {
          element.className = element.className.replace(classname, '');
          element.className = element.className.replace('  ', ' ');
          element.className = element.className.trim();
        }
      }

      /**
       * Change the css transform configuration on target element.
       *
       * @param {Element} target    The element to edited
       * @param {string}  transform The css transform configuration of target
       *
       * @private
       */
      function changeTransform(target, transform) {
        target.style['-webkit-transform'] = transform;
        target.style['transform'] = transform;
      }

      /**
       * Translate the element with Translate 3D CSS.
       *
       * @param {Element} target   The element
       * @param {Boolean} vertical Check if the vertical direction
       * @param {Number}  delta    The delta of translate
       *
       * @private
       */
      function changeTranslate(target, vertical, delta) {
        var trans = vertical ?
        '0px, ' + delta + 'px, 0px'
          : delta + 'px, 0px, 0px';

        changeTransform(target, 'translate3d(' + trans + ')');
      }

      Polymer('custom-scroller', {
        /**
         * @attribute containerSelector
         * @type String
         */
        containerSelector: '::shadow [layout]',

        /**
         * The `scrollbarMinSize` attribute defined the minimum size of scrollbar.
         *
         * @attribute scrollbarMinSize
         * @type Number
         */
        scrollbarMinSize: 14,

        /**
         * The wrapper element.
         *
         * @type Element|null
         * @private
         */
        wrapper: null,

        /**
         * The container element.
         *
         * @type Element|null
         * @private
         */
        container: null,

        /**
         * The scrollbar element.
         *
         * @type Element|null
         * @private
         */
        scrollbar: null,

        /**
         * @type Number
         * @private
         */
        nativeScrollSize: 0,

        created: function () {
          this.nativeScrollSize = getNativeScrollWidth();
        },

        ready: function () {
          if (this.nativeScrollSize > 0) {
            this.wrapper = this.querySelector('[scrollwrapper]');
            this.wrapper.style['overflow-x'] = 'hidden';
            this.container = this.wrapper.querySelector(this.containerSelector);

            if (null !== this.container) {
              this.container.style['overflow-y'] = 'scroll';
              this.container.style['margin-right'] = '-' + (this.nativeScrollSize - (isFirefox() ? 1 : 0)) + 'px';
              this.scrollbar = generateScrollbar(this);

              this.wrapper.addEventListener('scroll', this.refreshScrollbarPosition.bind(this));
              window.addEventListener('resize', this.resizeScrollbar.bind(this));
            }
          }
        },

        domReady: function () {
          this.resizeScrollbar();
        },

        detached: function () {
          if (this.nativeScrollSize > 0) {
            if (null !== this.container) {
              this.container.style['overflow-y'] = '';
              this.container.style['margin-right'] = '';
            }

            this.wrapper.style['overflow-x'] = '';
            this.wrapper.removeEventListener('scroll', this.refreshScrollbarPosition.bind(this));
          }
        },

        /**
         * The `resizeScrollbar` method will resizes the scrollbar and refreshes her position.
         *
         * @method resizeScrollbar
         */
        resizeScrollbar: function () {
          if (!this.scrollbar || !this.container) {
            return;
          }

          var wrapperSize = this.wrapper.scrollHeight,
            contentSize = this.container.scrollHeight,
            size = Math.max(this.scrollbarMinSize, Math.round(wrapperSize * Math.min(wrapperSize / contentSize, 1)));

          if (size < wrapperSize) {
            addClass(this.scrollbar, 'scrollbar-active');
          } else {
            removeClass(this.scrollbar, 'scrollbar-active');
          }

          this.scrollbar.style.height = size + 'px';
          this.refreshScrollbarPosition();
        },

        /**
         * The `refreshScrollbarPosition` method will refreshes the scrollbar position.
         *
         * @method refreshScrollbarPosition
         */
        refreshScrollbarPosition: function () {
          if (!this.scrollbar || !this.container) {
            return;
          }

          var position = this.container.scrollTop,
            wrapperSize = this.wrapper.scrollHeight,
            contentSize = this.container.scrollHeight,
            percentScroll = position / (contentSize - wrapperSize),
            scrollbarSize = this.scrollbar.scrollHeight,
            delta = Math.round(percentScroll * (wrapperSize - scrollbarSize));

          changeTranslate(this.scrollbar, true, delta);
        }
      })

    })();
  </script>
</polymer-element>
